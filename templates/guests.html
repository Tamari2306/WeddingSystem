<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if current_environment == 'development' %}
            Development - Wedding Guest System
        {% else %}
            Wedding Guest System
        {% endif %}
    </title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            {% if current_environment == 'development' %}
                <h1 class="text-danger">Wedding Guest System <span class="badge badge-danger">DEVELOPMENT MODE</span></h1>
            {% else %}
                <h1>Wedding Guest System</h1>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn btn-warning">Logout</a>
        </div>

        <div class="mb-3">
            <a href="{{ url_for('upload_csv') }}" class="btn btn-primary">Upload Guests (CSV)</a>
            <a href="{{ url_for('download_csv') }}" class="btn btn-info">Download Guest Data (CSV)</a>
            <a href="{{ url_for('zip_qr_codes_web') }}" class="btn btn-secondary">Download All QR Codes</a>
            <a href="{{ url_for('generate_guest_cards') }}" class="btn btn-success">Generate Guest Cards</a>
            <a href="{{ url_for('download_all_cards') }}" class="btn btn-info">Download All Guest Cards</a>
            <a href="{{ url_for('scan_qr') }}" class="btn btn-success">Scan QR Code</a>
            <a href="{{ url_for('regenerate_qr_codes') }}" class="btn btn-dark">Regenerate All QR Codes</a>
            <a href="{{ url_for('clear_all_data') }}" class="btn btn-danger mt-2" onclick="return confirm('ARE YOU ABSOLUTELY SURE YOU WANT TO DELETE ALL GUEST DATA, QR CODES, AND GUEST CARDS? THIS CANNOT BE UNDONE!');">Clear All Data (DANGER ZONE!)</a>
        </div>

        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Visual ID</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>QR Code</th>
                    <th>Entered?</th>
                    <th>Entry Time</th>
                    <th>Card Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for guest in guests %}
                <tr>
                    <td>{{ guest.visual_id }}</td>
                    <td>{{ guest.name }}</td>
                    <td>{{ guest.phone }}</td>
                    <td>
                        {% if guest.qr_code_url %}
                        <a href="{{ guest.qr_code_url }}" target="_blank">View QR</a>
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if guest.has_entered %}
                            Yes
                        {% else %}
                            No
                        {% endif %}
                    </td>
                    <td>{{ guest.entry_time.strftime('%Y-%m-%d %H:%M:%S') if guest.entry_time else 'N/A' }}</td>
                    <td>{{ guest.card_type | capitalize }}</td>
                    <td>
                        <a href="{{ url_for('edit_guest', guest_id=guest.id) }}" class="btn btn-sm btn-primary">Edit</a>
                        <a href="{{ url_for('delete_guest', guest_id=guest.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete {{ guest.name }}? This will also delete their QR code and guest card images.');">Delete</a>
                        <a href="{{ url_for('download_card', filename='GUEST-' + '%04d' % guest.visual_id + '-' + guest.name.upper().replace(' ', '_') + '.png') }}" class="btn btn-sm btn-success">Card</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>